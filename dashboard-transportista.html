<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUKKER - Dashboard Transportista</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- NAVBAR -->
    <div class="navbar">
        <div class="logo">üöö TRUKKER - Transportista</div>
        <div>
            <span id="user-name" style="margin-right: 1rem;"></span>
            <button onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>Bienvenido al Dashboard</h1>
            <p>Gestiona tus viajes y ganancias desde aqu√≠</p>

            <!-- ESTAD√çSTICAS -->
            <div class="stats">
                <div class="stat-card">
                    <h3>Viajes Completados</h3>
                    <div class="number" id="viajes-completados">0</div>
                </div>
                <div class="stat-card">
                    <h3>Solicitudes Activas</h3>
                    <div class="number" id="solicitudes-activas">0</div>
                </div>
                <div class="stat-card">
                    <h3>Calificaci√≥n</h3>
                    <div class="number" id="calificacion">5.0</div>
                </div>
                <div class="stat-card">
                    <h3>Ingresos Est.</h3>
                    <div class="number" id="ingresos">$0</div>
                </div>
            </div>
        </div>

        <!-- MIS CAPACIDADES -->
        <div class="section">
            <h2>Mis Capacidades</h2>
            <button class="btn" onclick="openCapacidadModal()">‚ûï Publicar Nueva Capacidad</button>
            <table id="capacidades-table">
                <thead>
                    <tr>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Toneladas</th>
                        <th>Precio/Ton</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="capacidades-empty" class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <p>No tienes capacidades publicadas</p>
            </div>
        </div>

        <!-- PERFIL -->
        <div class="section">
            <h2>Mi Perfil de Transportista</h2>
            <button class="btn" onclick="openPerfilModal()">Editar Perfil</button>
            <table style="margin-top: 1rem;">
                <tr><th>Campo</th><th>Valor</th></tr>
                <tr><td>Nombre</td><td id="perfil-nombre">-</td></tr>
                <tr><td>Email</td><td id="perfil-email">-</td></tr>
                <tr><td>Tel√©fono</td><td id="perfil-telefono">-</td></tr>
                <tr><td>Ciudad</td><td id="perfil-ciudad">-</td></tr>
                <tr><td>Tipo de Cami√≥n</td><td id="perfil-tipo">-</td></tr>
                <tr><td>Placas</td><td id="perfil-placas">-</td></tr>
                <tr><td>Capacidad</td><td id="perfil-capacidad">-</td></tr>
                <tr><td>Experiencia</td><td id="perfil-experiencia">-</td></tr>
            </table>
        </div>
    </div>

    <!-- MODAL CAPACIDAD -->
    <div id="capacidad-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCapacidadModal()">&times;</span>
            <h2>Publicar Nueva Capacidad</h2>
            <form onsubmit="guardarCapacidad(event)">
                <div class="form-group">
                    <label>Origen</label>
                    <input type="text" id="cap-origen" required>
                </div>
                <div class="form-group">
                    <label>Destino</label>
                    <input type="text" id="cap-destino" required>
                </div>
                <div class="form-group">
                    <label>Toneladas</label>
                    <input type="number" id="cap-toneladas" required>
                </div>
                <div class="form-group">
                    <label>Precio por Tonelada ($)</label>
                    <input type="number" id="cap-precio" required>
                </div>
                <button type="submit" class="btn">Publicar Capacidad</button>
            </form>
        </div>
    </div>

    <!-- MODAL PERFIL -->
    <div id="perfil-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePerfilModal()">&times;</span>
            <h2>Editar Perfil</h2>
            <form onsubmit="guardarPerfil(event)">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="edit-nombre" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="edit-telefono" required>
                </div>
                <div class="form-group">
                    <label>Ciudad</label>
                    <input type="text" id="edit-ciudad" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Cami√≥n</label>
                    <select id="edit-tipo" required>
                        <option value="">Selecciona...</option>
                        <option value="volteo">Volteo</option>
                        <option value="caja">Caja</option>
                        <option value="refrigerado">Refrigerado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Placas</label>
                    <input type="text" id="edit-placas" required>
                </div>
                <div class="form-group">
                    <label>Capacidad (Toneladas)</label>
                    <input type="number" id="edit-capacidad" required>
                </div>
                <div class="form-group">
                    <label>A√±os de Experiencia</label>
                    <input type="number" id="edit-experiencia" required>
                </div>
                <button type="submit" class="btn">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- ========================================
         FIREBASE SDKs - COMPAT MODE v10.8.0
         ======================================== -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        let currentUser = null;

        // Verificar autenticaci√≥n
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-name').textContent = user.email;
                await cargarDatos();
            } else {
                window.location.href = 'login.html';
            }
        });

        async function cargarDatos() {
            try {
                const userDoc = await firebase.firestore().collection('transportistas').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    // Estad√≠sticas
                    document.getElementById('viajes-completados').textContent = data.viajesCompletados || 0;
                    document.getElementById('ingresos').textContent = '$' + (data.ingresos || 0);
                    document.getElementById('calificacion').textContent = (data.calificacion || 5).toFixed(1);
                    
                    // Perfil
                    document.getElementById('perfil-nombre').textContent = data.nombre || '-';
                    document.getElementById('perfil-email').textContent = data.email || '-';
                    document.getElementById('perfil-telefono').textContent = data.telefono || '-';
                    document.getElementById('perfil-ciudad').textContent = data.ciudad || '-';
                    document.getElementById('perfil-tipo').textContent = data.tipoCamion || '-';
                    document.getElementById('perfil-placas').textContent = data.placas || '-';
                    document.getElementById('perfil-capacidad').textContent = data.capacidad || '-';
                    document.getElementById('perfil-experiencia').textContent = data.experiencia || '-';
                    
                    // Pre-llenar modal editar
                    document.getElementById('edit-nombre').value = data.nombre || '';
                    document.getElementById('edit-telefono').value = data.telefono || '';
                    document.getElementById('edit-ciudad').value = data.ciudad || '';
                    document.getElementById('edit-tipo').value = data.tipoCamion || '';
                    document.getElementById('edit-placas').value = data.placas || '';
                    document.getElementById('edit-capacidad').value = data.capacidad || '';
                    document.getElementById('edit-experiencia').value = data.experiencia || '';
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        function openCapacidadModal() {
            document.getElementById('capacidad-modal').classList.add('active');
        }

        function closeCapacidadModal() {
            document.getElementById('capacidad-modal').classList.remove('active');
        }

        function openPerfilModal() {
            document.getElementById('perfil-modal').classList.add('active');
        }

        function closePerfilModal() {
            document.getElementById('perfil-modal').classList.remove('active');
        }

        async function guardarCapacidad(e) {
            e.preventDefault();
            
            try {
                const data = {
                    uid: currentUser.uid,
                    origen: document.getElementById('cap-origen').value,
                    destino: document.getElementById('cap-destino').value,
                    toneladas: parseInt(document.getElementById('cap-toneladas').value),
                    precio: parseInt(document.getElementById('cap-precio').value),
                    estado: 'activo',
                    createdAt: new Date()
                };
                
                await firebase.firestore().collection('capacidades').add(data);
                alert('‚úÖ Capacidad publicada exitosamente');
                closeCapacidadModal();
                document.querySelector('#capacidad-modal form').reset();
                await cargarDatos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function guardarPerfil(e) {
            e.preventDefault();
            
            try {
                const data = {
                    nombre: document.getElementById('edit-nombre').value,
                    telefono: document.getElementById('edit-telefono').value,
                    ciudad: document.getElementById('edit-ciudad').value,
                    tipoCamion: document.getElementById('edit-tipo').value,
                    placas: document.getElementById('edit-placas').value,
                    capacidad: parseInt(document.getElementById('edit-capacidad').value),
                    experiencia: parseInt(document.getElementById('edit-experiencia').value)
                };
                
                await firebase.firestore().collection('transportistas').doc(currentUser.uid).update(data);
                await firebase.firestore().collection('users').doc(currentUser.uid).update(data);
                
                alert('‚úÖ Perfil actualizado');
                closePerfilModal();
                await cargarDatos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('‚úÖ Sesi√≥n cerrada');
                        window.location.href = 'login.html';
                    })
                    .catch((error) => {
                        console.error('Error logout:', error);
                        window.location.href = 'login.html'; // Forzar redirect
                    });
            }
        }

        // Verificar Firebase al cargar
        window.addEventListener('load', () => {
            console.log('‚úÖ dashboard-transportista.html cargado');
        });
    </script>
</body>
</html>